name: Build & Deploy

on:
  push:
    branches: [ master, beta ]

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    outputs:
      build_success: ${{ steps.build.outputs.success }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        id: build
        run: |
          pnpm run build
          echo "Build completed successfully"
          echo "success=true" >> $GITHUB_OUTPUT

      - name: Create zip archive of build files with versioned name
        run: |
          VERSION=$(node -p "require('./package.json').version")
          cd dist
          zip -r ../guess-song-king-$VERSION.zip .

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist-package
          path: guess-song-king-*.zip
          if-no-files-found: error
          retention-days: 1

  release:
    name: Semantic Release
    needs: build
    if: needs.build.outputs.build_success == 'true' && github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/beta')
    runs-on: ubuntu-latest
    outputs:
      new_release: ${{ steps.semantic.outputs.new_release }}
      new_release_version: ${{ steps.semantic.outputs.new_release_version }}
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: dist-package
          path: .

      - name: Verify build files
        run: |
          echo "Build files:"
          ls -la guess-song-king-*.zip || echo "No versioned zip file found"

      - name: Run semantic-release
        id: semantic
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release@23

  deploy:
    needs: [release, build]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/beta')
    runs-on: ubuntu-latest
    environment: oss-deploy
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: dist-package

      - name: Extract files
        run: |
          unzip guess-song-king-*.zip -d dist

      - name: Deploy to OSS
        uses: fangbinwei/aliyun-oss-website-action@v1
        with:
          accessKeyId: ${{ secrets.OSS_ACCESS_KEY_ID }}
          accessKeySecret: ${{ secrets.OSS_ACCESS_KEY_SECRET }}
          bucket: ${{ vars.OSS_BUCKET }}
          endpoint: ${{ vars.OSS_REGION }}
          folder: dist
          incremental: true
          skipSetting: true

  purge-edgeone:
    needs: [release, deploy]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    environment: edgeone
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install EdgeOne SDK dependency
        run: npm install tencentcloud-sdk-nodejs

      - name: Purge EdgeOne CDN cache
        env:
          TENCENT_CLOUD_SECRET_ID: ${{ secrets.TENCENT_CLOUD_SECRET_ID }}
          TENCENT_CLOUD_SECRET_KEY: ${{ secrets.TENCENT_CLOUD_SECRET_KEY }}
          EDGEONE_ZONE_ID: ${{ secrets.EDGEONE_ZONE_ID }}
          EDGEONE_TARGETS: ${{ secrets.EDGEONE_TARGETS }}
          EDGEONE_PURGE_TYPE: ${{ env.EDGEONE_PURGE_TYPE }}
          EDGEONE_REGION: ${{ secrets.EDGEONE_REGION }}
          EDGEONE_TARGETS_INPUT: ${{ env.EDGEONE_TARGETS_INPUT }}
        run: |
          cat <<'EOF' > clearCache.js
          const tencentcloud = require('tencentcloud-sdk-nodejs');
          const TeoClient = tencentcloud.teo.v20220901.Client;

          const zoneId = process.env.EDGEONE_ZONE_ID;
          const region = process.env.EDGEONE_REGION || 'ap-chengdu';
          const targets = (process.env.EDGEONE_TARGETS_INPUT || process.env.EDGEONE_TARGETS || '')
            .split(/[\n,]/)
            .map(item => item.trim())
            .filter(Boolean);
          const type = process.env.EDGEONE_PURGE_TYPE || 'purge_host';

          if (!zoneId) {
            throw new Error('EDGEONE_ZONE_ID is required.');
          }

          if (!targets.length) {
            throw new Error('EDGEONE_TARGETS must contain at least one entry.');
          }

          const client = new TeoClient({
            credential: {
              secretId: process.env.TENCENT_CLOUD_SECRET_ID,
              secretKey: process.env.TENCENT_CLOUD_SECRET_KEY,
            },
            region,
            profile: {
              httpProfile: {
                endpoint: 'teo.tencentcloudapi.com',
              },
            },
          });

          client.CreatePurgeTask({
            ZoneId: zoneId,
            Type: type,
            Targets: targets,
          }).then(
            data => {
              console.log('Purge task submitted:', data);
            },
            err => {
              console.error('EdgeOne purge failed:', err);
              process.exit(1);
            }
          );
          EOF

          node clearCache.js
